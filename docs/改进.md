# 改进

## 架构

最大能提升的地方是架构，项目采用单Reactor多线程模型，存在两个问题：

1. 线程需要对工作队列频繁加锁，这是一个很浪费时间的操作
2. 一个线程一次只能处理一个client的请求，当请求数量越来越多时，工作队列会堆积越来越多的任务对象，服务器对客户端的响应将会变慢；通过增加线程数并不能解决这个问题因为如果多于cpu核数的话线程间的切换也会限制性能

因此有主从Reactor模型来改进这个问题，主Reactor只负责监听listenfd，有链接时accept然后派给从Reactor，从Reactor有自己的epoll_wait来处理IO，这样一个线程可以处理多个请求

## 文件发送

目前文件发送采用了用mmap文件映射到内存然后往socket写的方式，需要DMA先把文件从磁盘拷贝到内核（第一次cp），进程通过内存映射能访问文件并把文件写到socket的发送缓冲区（第二次cp），内核把socket的数据发往网卡（第三次cp），一共需要三次copy

如果采用sendfile，那么需要DMA先把文件从磁盘拷贝到内核（第一次cp），内核直接将数据发到网卡（二次cp），cp次数更少

## 功能

1. 日志功能
2. 解析POST请求